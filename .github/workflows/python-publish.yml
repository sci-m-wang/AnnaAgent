# 工作流名称
name: Publish AnnaAgent to PyPI

on:
  # 1. 自动触发：当你创建一个 "Published" 状态的 GitHub Release 时
  release:
    types: [published]
    
  # 2. 手动触发：在 "Actions" 选项卡上添加一个 "Run workflow" 按钮
  workflow_dispatch:

# 允许这个工作流签出代码
permissions:
  contents: read

jobs:
  # ----------------------------------------------
  # Job 1: 构建你的包 (wheel 和 sdist)
  # ----------------------------------------------
  build:
    name: Build distribution
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          # 我为你选择了一个具体的、现代的 Python 版本
          python-version: "3.10" 

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install build

      - name: Build package
        run: python -m build

      - name: Upload distributions
        uses: actions/upload-artifact@v4
        with:
          # 这个名字必须和下面 pypi-publish job 中的名字一致
          name: release-dists 
          path: dist/

  # ----------------------------------------------
  # Job 2: 将构建好的包发布到 PyPI
  # ----------------------------------------------
  pypi-publish:
    name: Publish to PyPI
    needs: [build] # 确保 Job 1 (build) 成功后才运行
    runs-on: ubuntu-latest

    # 关键：这允许工作流从 PyPI 获取一个临时的 OIDC 令牌
    permissions:
      id-token: write 

    # 关键：定义发布环境
    environment:
      name: pypi
      # 我为你的项目定制了 URL，它会显示在 GitHub 的部署日志中
      url: https://pypi.org/project/AnnaAgent/${{ github.event.release.name }}

    steps:
      - name: Retrieve release distributions
        uses: actions/download-artifact@v4
        with:
          name: release-dists # 必须和上面 build job 中的名字一致
          path: dist/

      - name: Publish package to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        # 这里的 with: ... 是可选的，因为 action 会自动查找 OIDC 令牌
        # 它不需要 password: ${{ secrets.PYPI_API_TOKEN }}
